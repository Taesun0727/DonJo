pipeline {

   agent any

   stages{
    stage('프론트엔드 자동 배포'){

        stages{
            stage('프론트엔드 이미지 생성'){
                            steps{
                                dir('frontend')
                                {
                                dir('don-jo-app'){
                                sh "docker build -t react-image ."
                                }
                                }
                                }
        }
            stage('프론트엔드 컨테이너 삭제'){
                                    steps{
                                    catchError{
                                        sh "docker rm --force frontend"
                                        }
                                                           }
                                                       }

                    stage('컨테이너 생성') {
                      steps {
                        sh "docker run -d -p 3000:3000 --name frontend react-image"
                      }
                    }
    }
    }
    stage('백엔드 자동 배포') {
        stages {
                stage('gradlew 권한'){
                    steps{
                          dir('backend'){
                          sh "chmod +x gradlew"
                                }
                                }
                               }
               stage('백엔드 이미지 생성'){
                steps{
                    dir('backend'){
                    sh "./gradlew bootBuildImage"
                    }
                }
               }

               stage('백엔드 컨테이너 삭제'){
                               steps{
                               catchError{
                                   sh "docker rm --force backend"
                                   }
                                                      }
                                                  }

               stage('백엔드 컨테이너 생성') {
                 steps {
                   sh "docker run -d -p 8081:8080 --name backend backend:0.0.1-SNAPSHOT"
                 }
               }
           }
          }
     stage('가이드 자동 배포'){

            stages{
                stage('가이드 이미지 생성'){
                                steps{
                                    dir('frontend-guide')
                                    {
                                    catchError{
                                    sh "docker build -t guide-image ."
                                    }
                                    }
                                    }
            }
                stage('가이드 컨테이너 삭제'){
                                        steps{
                                        catchError{
                                            sh "docker rm --force guide"
                                            }
                                                               }
                                                           }

                        stage('컨테이너 생성') {
                          steps {
                          catchError{
                            sh "docker run -d -p 1313:1313 --name guide guide-image"
                            }
                          }
                        }
        }
        }

}
}
